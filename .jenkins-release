node {
  parameters {
  // Application variables
    string(name: 'tower_host',            defaultValue: 'https://ansible-tower.devops.victorock.io',  description: 'Tower Server. ex: https://ansible-tower.devops.victorock.io')
    string(name: 'tower_credential',      defaultValue: 'ansible-tower.devops.victorock.io-devops',   description: 'Tower Credential from Credentials. ex: ansible-tower.devops.victorock.io-devops')
    string(name: 'application_repo',      defaultValue: 'https://github.com/victorock/phillyapp.git', description: 'The Application repository')
    string(name: 'environment',           defaultValue: 'dev',                                        description: 'The environment to deploy: dev/prod')
  }

  stage('Clone Repository'){
    git 'https://github.com/victorock/phillyapp.git'
  }

  stage('Prepare tower-cli Configuration'){
    withCredentials([
                      usernamePassword(
                        credentialsId: '${tower_credential}',
                        usernameVariable: 'tower_username',
                        passwordVariable: 'tower_password'
                      )
                    ])
    {

      sh """
        tower-cli config host "${tower_host}"
        tower-cli config verify_ssl False
        tower-cli config username "${tower_username}"
        tower-cli config password "${tower_password}"
        tower-cli config format json
        tower-cli config verbose True
      """

    }
  }

  stage('Publish project in Tower'){
    //Use Pipeline Utility Steps plugin to read information from pom.xml into env variables
    def  artifactId = readMavenPom().getArtifactId()
    def  version = readMavenPom().getVersion()

      sh """
        tower-cli       project create                                              \
          --scm-type        "git"                                                   \
          --scm-branch      "master"                                                \
          --scm-url         "${application_repo}"                                   \
          --name            "devops-application-project: ${artifactId}-${version}"  \
          --description     "Created by Jenkins"                                    \
          --organization    "DEMO"                                                  \
          --insecure
        """
    }

  stage('Publish Job Template in Tower'){
    //Use Pipeline Utility Steps plugin to read information from pom.xml into env variables
    def  artifactId = readMavenPom().getArtifactId()
    def  version = readMavenPom().getVersion()

    sh """
    tower-cli       job_template create                                             \
      --job-type        run                                                         \
      --name            "devops-application-deploy: ${artifactId}-${version}"       \
      --description     "Created by Jenkins"                                        \
      --inventory       "devops"                                                    \
      --project         "devops-application-project: ${artifactId}-${version}"      \
      --playbook        "playbooks/deploy.yml"                                      \
      --credential      "devops-application-credential: ${artifactId}"              \
      --extra-vars      "---
app_release: ${artifactId}-${version}
environment: ${environment}"                                                 \
      --insecure
    """
  }

  stage ('Deploy with Ansible Tower') {

    //Use Pipeline Utility Steps plugin to read information from pom.xml into env variables
    def  artifactId = readMavenPom().getArtifactId()
    def  version = readMavenPom().getVersion()

    sh """
    tower-cli           job launch                                                  \
      --job-template    "devops-application-deploy: ${artifactId}-${version}"       \
      --inventory       "devops"                                                    \
      --credential      "devops-application-credential: ${artifactId}"
    """
  }
}
